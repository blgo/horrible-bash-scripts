#!/bin/bash
#reads the ./.weatherforecast file, generated by download_weatherforecast script
#debug function, show the retrieved data

function debug {
if [ "$1" = "-d" ]
then
echo "line=$LINE"
echo "temperature=$TEMPERATURE"
echo "wind=$WIND"
echo "rain=$RAIN"
echo "clouds=$CLOUDS"
echo "numberoffiles=$NUMBEROFILES"
echo "dawn=$SUNSHINEHOUR:$SUNSHINEMINUTE"
echo "dusk=$SUNSETHOUR:$SUNSETMINUTE"
echo "numberoflines=$NUMBEROFLINES="
echo "amanecerline=$AMANECERLINE"
echo "amanecertime=$AMANECERTIME"
echo "ocasoline=$OCASOLINE"
echo "ocasotime=$OCASOTIME"
echo "day=$day"
echo "icon=$ICON"
echo ""
fi
}

function newday {
if [ $HOUR -eq 24 ]
then 
HOUR=00
fi
}

function currentday {
LINE=`cat -n "$DIR".weatherforecast | sed -e '/[a-Z]*,/!d' -e 's/[a-Z]*,//' -e 's/\t/\ /g' -e 's/\ *//' |  grep $DAY | awk '{print$1}'`
sed ''$LINE',100 !d' < "$DIR".weatherforecast | grep -m 1 "$HOUR:00" > "$DIR".weatherforecast1
TEMPERATURE="`awk '{ print $2 }' < "$DIR".weatherforecast1 | sed 's/º//'`"
WIND="`awk '{ print $4 }' < "$DIR".weatherforecast1`"
RAIN="`awk '{ print $5 }' < "$DIR".weatherforecast1`"
CLOUDS="`awk '{ print $6 }' < "$DIR".weatherforecast1 | sed 's/%/ /' `"
}

function sunshinetime {
NUMBEROFLINES="`wc -l < "$DIR".weatherforecast`"
AMANECERLINE="$(($NUMBEROFLINES-1))"
AMANECERTIME="`awk '{print$1}' < "$DIR".weatherforecast | sed -e ''$AMANECERLINE' !d'`"
SUNSHINEHOUR="`echo "$AMANECERTIME" | sed -e 's/\([0-9][0-9]\):[0-9][0-9]/\1/' -e 's/0\([0-9]\)/\1/g'`"
SUNSHINEMINUTE="`echo "$AMANECERTIME" | sed -e 's/[0-9][0-9]:\([0-9][0-9]\)/\1/' -e 's/0\([0-9]\)/\1/g'`"
OCASOLINE="$NUMBEROFLINES"
OCASOTIME="`awk '{print$1}' < "$DIR".weatherforecast | sed -e ''$OCASOLINE' !d'`"
SUNSETHOUR="`echo "$OCASOTIME" | sed -e 's/\([0-9][0-9]\):[0-9][0-9]/\1/' -e 's/0\([0-9]\)/\1/g'`"
SUNSETMINUTE="`echo "$OCASOTIME" | sed -e 's/[0-9][0-9]:\([0-9][0-9]\)/\1/' -e 's/0\([0-9]\)/\1/g'`"
}
function chooseicon {
DAY="`date +%_d`"
HOUR="`date +%_H`"
day=0
if [ "$HOUR" -ge "$SUNSHINEHOUR" ] && [ "$HOUR" -le "$SUNSETHOUR" ]
		then 
		day=1
		if [ "$HOUR" -eq "$SUNSHINEHOUR" ]
			then 
			if [ "$MINUTE" -ge "$SUNSHINEMINUTE" ] 
				then
				day=1
				else
				day=0
			fi		
		fi	
		if [ "$HOUR" -eq "$SUNSETHOUR" ]
			then
			if [ "$MINUTE" -le "$SUNSETMINUTE" ]
				then
				day=1
				else
				day=0
			fi
		fi
fi
vector=0
if [ "$day" -eq 1 ]
	then
	vector=$(( $vector + 1 ))
fi	
if [ "$CLOUDS" -ge 50 ]
	then
	vector=$(( $vector + 10  ))
	if [ "$RAIN" -gt 0 ]
		then
		vector=$(( $vector + 100  ))
	fi
fi

case "$vector" in
	0)	ICON=moon.png;;
	1)	ICON=sun.png;;
	10)	ICON=cloudmoon.png;;
	11)     ICON=suncloud.png;;
	110)	ICON=rainmoon.png;;
	111)	ICON=sunrain.png;;
esac
ICON="$ICON"
}

function isnumeric {
if [ -n "`echo $1 | sed 's/[0-9]//g'`" ]; then
    echo '1' #is not numeric 
else
    echo '0' #is numeric
fi
}

function notify {

if [ -n "$RAIN" ] && [ `isnumeric "$RAIN" ` -eq '0' ]
	then
		Lluvia="LLuvia=$RAIN mm"
	fi
if [ -n "$WIND" ] && [ `isnumeric "$WIND" ` -eq '0' ]
	then
		Viento="Viento:$WIND Km/h"
	fi
if [ -n "$TEMPERATURE" ] && [ `isnumeric "$TEMPERATURE"` -eq '0' ]
	then
		Temperatura="Temperatura: $TEMPERATUREºC"
		nubes="Nubes:$CLOUDS%"
	fi
if [ -n "$day" ] && [ $day -eq 1 ]
	then 
		daytime="day"
		COLOR="^fg(yellow)"
		else
		daytime="night"
		COLOR="^fg(white)"
	fi
#notify-send --expire-time=6000 -i "$DIR".weathericons/$ICON "`date +%H:%M`" "`date +%d\ %B\ %n%A`$Temperatura$Viento" 
#xmessage -timeout 3 ""`date +%H:%M`" "`date +%d\ %B\ %n%A`"$Temperatura$Viento$Lluvia$daytime"
if [ "$1" != "-echo"  ]
then
echo -e "$COLOR $(date +%H:%M\ \-\ %d\ %B\ %A) ^fg(green)$Temperatura $Viento $nubes $Lluvia" | dzen2 -p 5  &
fi
echo -e "$COLOR $(date +%d\ %B\ %A) -- $Temperatura $Viento $nubes "
}
DIR="$HOME/"
HOUR="`date +%_H`"
MINUTE="`date +%_M`"
MONTH="`date +%b`"
DAY="`date +%d`"
HOUR=$(( $HOUR + 1 ))
newday
currentday
sunshinetime
chooseicon
notify $1
debug $1
rm ""$DIR".weatherforecast1"
exit 0
